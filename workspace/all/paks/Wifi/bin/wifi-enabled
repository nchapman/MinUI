#!/bin/sh
# Check if wifi is currently enabled
# Exit 0 = enabled, Exit 1 = disabled

BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$BIN_DIR")"

export PATH="$PAK_DIR/bin/$PLATFORM:$PAK_DIR/bin:$PATH"
export LD_LIBRARY_PATH="$PAK_DIR/lib/$PLATFORM:$PAK_DIR/lib:$LD_LIBRARY_PATH"

main() {
	# Determine system.json path
	case "$PLATFORM" in
		miyoomini) SYSTEM_JSON_PATH="/appconfigs/system.json" ;;
		my282)     SYSTEM_JSON_PATH="/config/system.json" ;;
		my355)     SYSTEM_JSON_PATH="/userdata/system.json" ;;
		*)         SYSTEM_JSON_PATH="/mnt/UDISK/system.json" ;;
	esac

	# Check system.json wifi flag
	if [ ! -f "$SYSTEM_JSON_PATH" ]; then
		echo '{"wifi": 0}' >"$SYSTEM_JSON_PATH"
	elif [ ! -s "$SYSTEM_JSON_PATH" ]; then
		echo '{"wifi": 0}' >"$SYSTEM_JSON_PATH"
	fi

	if [ -f "$SYSTEM_JSON_PATH" ]; then

		if [ -x /usr/trimui/bin/systemval ]; then
			wifi_enabled="$(/usr/trimui/bin/systemval wifi)"
		else
			wifi_enabled="$(jq '.wifi' "$SYSTEM_JSON_PATH" 2>/dev/null)"
		fi

		[ "$wifi_enabled" != "1" ] && return 1
	fi

	# Check rfkill status
	if command -v rfkill >/dev/null 2>&1; then
		wifi_status="$(rfkill list wifi 2>/dev/null || true)"
		echo "$wifi_status" | grep -q "blocked: yes" && return 1
	fi

	# Check wpa_supplicant process
	pgrep wpa_supplicant >/dev/null 2>&1 || return 1

	# Check interface is up (0x1003 = IFF_UP | IFF_BROADCAST | IFF_RUNNING)
	[ "$(cat /sys/class/net/wlan0/flags 2>/dev/null)" != "0x1003" ] && return 1

	return 0
}

main "$@"
