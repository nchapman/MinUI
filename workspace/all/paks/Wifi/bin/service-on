#!/bin/sh
# Enable WiFi service

BIN_DIR="$(dirname "$0")"
PAK_DIR="$(dirname "$BIN_DIR")"

export PATH="$PAK_DIR/bin/$PLATFORM:$PAK_DIR/bin:$PATH"
export LD_LIBRARY_PATH="$PAK_DIR/lib/$PLATFORM:$PAK_DIR/lib:$LD_LIBRARY_PATH"

main() {
	# Handle platform alias
	if [ "$PLATFORM" = "tg3040" ] && [ -z "$DEVICE" ]; then
		export DEVICE="brick"
		export PLATFORM="tg5040"
	fi

	echo "Preparing to enable wifi..."

	# Update system.json for platforms that use it
	case "$PLATFORM" in
		miyoomini|my282|my355|tg5040)
			case "$PLATFORM" in
				miyoomini) SYSTEM_JSON_PATH="/appconfigs/system.json" ;;
				my282)     SYSTEM_JSON_PATH="/config/system.json" ;;
				my355)     SYSTEM_JSON_PATH="/userdata/system.json" ;;
				*)         SYSTEM_JSON_PATH="/mnt/UDISK/system.json" ;;
			esac

			[ ! -f "$SYSTEM_JSON_PATH" ] && echo '{"wifi": 0}' >"$SYSTEM_JSON_PATH"
			[ ! -s "$SYSTEM_JSON_PATH" ] && echo '{"wifi": 0}' >"$SYSTEM_JSON_PATH"

			if [ -x /usr/trimui/bin/systemval ]; then
				/usr/trimui/bin/systemval wifi 1
			else
				jq '.wifi = 1' "$SYSTEM_JSON_PATH" >"/tmp/system.json.tmp"
				mv "/tmp/system.json.tmp" "$SYSTEM_JSON_PATH"
			fi
			;;
	esac

	# Unblock wireless if rfkill is available
	if command -v rfkill >/dev/null 2>&1; then
		echo "Unblocking wireless..."
		rfkill unblock wifi 2>/dev/null || true
	fi

	echo "Starting wpa_supplicant..."

	case "$PLATFORM" in
		miyoomini)
			killall wpa_supplicant 2>/dev/null || true
			killall udhcpc 2>/dev/null || true

			# Load WiFi kernel module if needed
			if ! grep -q 8188fu /proc/modules 2>/dev/null; then
				insmod "$PAK_DIR/res/miyoomini/8188fu.ko"
			fi

			/customer/app/wpa_cli -i wlan0 disconnect 2>/dev/null || true
			/customer/app/wpa_cli -i wlan0 terminate 2>/dev/null || true
			/customer/app/wpa_cli -i wlan0 reconfigure 2>/dev/null || true

			ifconfig lo up
			/customer/app/axp_test wifion
			sleep 2
			ifconfig wlan0 up
			/customer/app/wpa_supplicant -B -D nl80211 -iwlan0 -c /appconfigs/wpa_supplicant.conf
			ln -sf /dev/null /tmp/udhcpc.log
			udhcpc -i wlan0 -s /etc/init.d/udhcpc.script &

			/customer/app/wpa_cli -i wlan0 reconnect
			iw dev wlan0 set power_save off
			;;

		tg5040)
			killall -15 wpa_supplicant 2>/dev/null || true
			killall -15 udhcpc 2>/dev/null || true
			ifconfig wlan0 up 2>/dev/null || true

			wpa_supplicant -B -D nl80211 -iwlan0 -c /etc/wifi/wpa_supplicant.conf -O /etc/wifi/sockets >/tmp/wpa_supplicant.log 2>&1

			# Handle stale socket file
			if grep -q "Delete '/etc/wifi/sockets/wlan0' manually" /tmp/wpa_supplicant.log 2>/dev/null; then
				killall -15 wpa_supplicant 2>/dev/null || true
				rm -f /etc/wifi/sockets/wlan0
				wpa_supplicant -B -D nl80211 -iwlan0 -c /etc/wifi/wpa_supplicant.conf -O /etc/wifi/sockets
			fi
			rm -f /tmp/wpa_supplicant.log

			if ! pgrep wpa_supplicant >/dev/null 2>&1; then
				echo "Failed to start wpa_supplicant"
				return 1
			fi
			udhcpc -i wlan0 -n &
			;;

		my282)
			killall -9 wpa_supplicant 2>/dev/null || true
			killall -9 udhcpc 2>/dev/null || true
			ifconfig wlan0 up 2>/dev/null || true

			if ! /etc/init.d/wpa_supplicant start; then
				echo "Failed to start wpa_supplicant via init.d"
			fi

			if ! pgrep wpa_supplicant >/dev/null 2>&1; then
				echo "Failed to start wpa_supplicant"
				return 1
			fi
			( (udhcpc -i wlan0 -q &) &)
			;;

		my355)
			killall -9 wpa_supplicant 2>/dev/null || true
			killall -9 udhcpc 2>/dev/null || true
			ifconfig wlan0 up 2>/dev/null || true

			wpa_supplicant -B -D nl80211 -iwlan0 -c /userdata/cfg/wpa_supplicant.conf

			if ! pgrep wpa_supplicant >/dev/null 2>&1; then
				echo "Failed to start wpa_supplicant"
				return 1
			fi
			( (udhcpc -i wlan0 -q &) &)
			;;

		rg35xxplus)
			ip link set wlan0 up
			iw dev wlan0 set power_save off

			systemctl start wpa_supplicant 2>/dev/null || true
			systemctl start systemd-networkd 2>/dev/null || true
			# Run netplan in background to avoid blocking boot if network is slow/unavailable
			netplan apply &
			;;

		*)
			echo "$PLATFORM is not a supported platform for Wifi.pak"
			return 1
			;;
	esac
}

main "$@"
